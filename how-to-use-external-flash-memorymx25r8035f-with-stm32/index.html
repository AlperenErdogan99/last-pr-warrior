<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>How to Use External Flash Memory(MX25R8035F) with Stm32 - LoveIt</title><meta name=Description content="Hugo theme - LoveIt"><meta property="og:title" content="How to Use External Flash Memory(MX25R8035F) with Stm32"><meta property="og:description" content="In this article, I will give informations about the &lsquo;How to use external flash memory with Nucleo-f303re development board&rsquo;.
In order to strengthen the narrative, I will proceed through the following topics."><meta property="og:type" content="article"><meta property="og:url" content="https://alperenerdogan99.github.io/last-pr-warrior/how-to-use-external-flash-memorymx25r8035f-with-stm32/"><meta property="og:image" content="https://alperenerdogan99.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-19T23:58:48+03:00"><meta property="article:modified_time" content="2022-09-20T16:02:47+03:00"><meta property="og:site_name" content="LoveIt"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://alperenerdogan99.github.io/logo.png"><meta name=twitter:title content="How to Use External Flash Memory(MX25R8035F) with Stm32"><meta name=twitter:description content="In this article, I will give informations about the &lsquo;How to use external flash memory with Nucleo-f303re development board&rsquo;.
In order to strengthen the narrative, I will proceed through the following topics."><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://alperenerdogan99.github.io/last-pr-warrior/how-to-use-external-flash-memorymx25r8035f-with-stm32/><link rel=next href=https://alperenerdogan99.github.io/last-pr-warrior/how-to-use-wiznet5500/><link rel=stylesheet href=/last-pr-warrior/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"How to Use External Flash Memory(MX25R8035F) with Stm32","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/alperenerdogan99.github.io\/last-pr-warrior\/how-to-use-external-flash-memorymx25r8035f-with-stm32\/"},"image":["https:\/\/alperenerdogan99.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","wordcount":2334,"url":"https:\/\/alperenerdogan99.github.io\/last-pr-warrior\/how-to-use-external-flash-memorymx25r8035f-with-stm32\/","datePublished":"2022-09-19T23:58:48+03:00","dateModified":"2022-09-20T16:02:47+03:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https:\/\/alperenerdogan99.github.io\/last-pr-warrior\/images\/avatar.png","width":225,"height":225}},"author":{"@type":"Person","name":"Last Pr Warrior"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/last-pr-warrior/ title=LoveIt><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>LoveIt</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/last-pr-warrior/posts/>Posts </a><a class=menu-item href=/last-pr-warrior/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/last-pr-warrior/ title=LoveIt><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>LoveIt</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/last-pr-warrior/posts/ title>Posts</a><a class=menu-item href=/last-pr-warrior/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">How to Use External Flash Memory(MX25R8035F) with Stm32</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/last-pr-warrior/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Last Pr Warrior</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-09-19>2022-09-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2334 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;11 minutes&nbsp;<span id=/last-pr-warrior/how-to-use-external-flash-memorymx25r8035f-with-stm32/ class=leancloud_visitors data-flag-title="How to Use External Flash Memory(MX25R8035F) with Stm32">
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;views
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div></div><div class=content id=content><p>In this article, I will give informations about the &lsquo;How to use external flash memory with Nucleo-f303re development board&rsquo;.
In order to strengthen the narrative, I will proceed through the following topics.</p><p><strong>1) What is Flash Memory?</strong></p><p><strong>2) What is the internal structure of Flash Memory?</strong></p><p><strong>3) How do you communicate with the MX25R8035F Flash Memory?</strong></p><p><strong>4) How to use MX25R8035F?</strong></p><hr><p><strong>1) What is Flash Memory?</strong></p><p>Flash Memory is a type of memory that does not lose its information even in a power cut and can be written and erased repeatedly. It is included in the development boards as an internal peripheral. If the memory space available here is insufficient, we have to use an external memory. We can solve this requirement with flash memory units.</p><hr><p><strong>2) What is the internal structure of Flash Memory?</strong></p><p>The data we send is stored in block structures. There are tens of pages (depending on the amount of memory) in each block structure.</p><p><figure><a class=lightgallery href=/how-to-use-flash-mem/internal-structure.png title="Internal Structure" data-thumbnail=/how-to-use-flash-mem/internal-structure.png data-sub-html="<h2>Internal Structure</h2><p>Internal Structure</p>"><img class=lazyload src=/last-pr-warrior/svg/loading.min.svg data-src=/how-to-use-flash-mem/internal-structure.png data-srcset="/how-to-use-flash-mem/internal-structure.png, /how-to-use-flash-mem/internal-structure.png 1.5x, /how-to-use-flash-mem/internal-structure.png 2x" data-sizes=auto alt=/how-to-use-flash-mem/internal-structure.png></a><figcaption class=image-caption>Internal Structure</figcaption></figure></p><p>Every data is stored in the page structures inside. To send data to page structures, that structure must be cleared beforehand. If the page we want to write data on is not cleaned, we probably cannot write the data or write it in a corrupted way. In order to avoid such problems, we must make sure that these pages are clean before storing data.</p><p>There is one point I would like to mention here. Each flash memory has a certain number of write-read lifetimes. If we clean before each write, we will cut the life of the peripheral in half. This poses a serious problem. The way to be followed in this regard, if we want to send data, our priority is always empty pages. Instead of cleaning the full page and writing the data, we should use the clean area.</p><p>Things to consider when choosing a Flash Memory are:</p><ul><li>Read/Write Speed</li><li>Read/Write Life</li><li>Communication protocol type</li></ul><hr><p><strong>3) How do you communicate with the MX25R8035F Flash Memory?</strong></p><p>MX25R8035F Flash Memory uses SPI as communication protocol. Therefore, you should have a good command of SPI. I&rsquo;m just going to talk about how to use the SPI protocol.</p><p>While answering this question, let&rsquo;s first examine the pins of the peripheral.</p><p><figure><a class=lightgallery href=/how-to-use-flash-mem/pinOut.png title="Flash Memory PinOut" data-thumbnail=/how-to-use-flash-mem/pinOut.png data-sub-html="<h2>Flash Memory PinOut</h2><p>Flash Memory PinOut</p>"><img class=lazyload src=/last-pr-warrior/svg/loading.min.svg data-src=/how-to-use-flash-mem/pinOut.png data-srcset="/how-to-use-flash-mem/pinOut.png, /how-to-use-flash-mem/pinOut.png 1.5x, /how-to-use-flash-mem/pinOut.png 2x" data-sizes=auto alt=/how-to-use-flash-mem/pinOut.png></a><figcaption class=image-caption>Flash Memory PinOut</figcaption></figure></p><p>We will use pins 1,2,4,5,6 and 8 from the above pins in order to communicate with SPI by running our peripheral.</p><p>Pins 4 and 8 will be used for feeds. The remaining pins will be used for the SPI connection.</p><ul><li>CS# : Channel selection</li><li>SO: SPI ->MISO</li><li>SI: SPI -> MOSI</li><li>SCLK: SPI ->SCLK</li></ul><p>In order for our peripheral to wake up and become active, the CS# pin is pulled to a low (logic 0).</p><p>To use SPI, we perform the configuration settings via STM32CubeIde as follows (You can revise the SPI speed according to the limit in the user guide):</p><p><figure><a class=lightgallery href=/how-to-use-flash-mem/Stm32CubdeIde-config.png title="IDE Configuration" data-thumbnail=/how-to-use-flash-mem/Stm32CubdeIde-config.png data-sub-html="<h2>IDE Configuration</h2><p>IDE Configuration</p>"><img class=lazyload src=/last-pr-warrior/svg/loading.min.svg data-src=/how-to-use-flash-mem/Stm32CubdeIde-config.png data-srcset="/how-to-use-flash-mem/Stm32CubdeIde-config.png, /how-to-use-flash-mem/Stm32CubdeIde-config.png 1.5x, /how-to-use-flash-mem/Stm32CubdeIde-config.png 2x" data-sizes=auto alt=/how-to-use-flash-mem/Stm32CubdeIde-config.png></a><figcaption class=image-caption>IDE Configuration</figcaption></figure></p><p>The following commands written with the HAL library are used to send and read data:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nf>HAL_SPI_Transmit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>hspi1</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>HAL_SPI_Receive</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>hspi1</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>500</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><hr><p><strong>4) How to use MX25R8035F?</strong></p><p>In order to control the MX25R8035F Flash Memory external peripheral, I will use a library that I have supplied and then revised and brought into working condition, and the user guide published by the manufacturer. I will share example codes in the article. First of all, I will try to examine each of its structures piece by piece.</p><p>Please find manufacturer guide !!!</p><p>Let&rsquo;s start by reviewing our library.</p><p>First we create some struct structures and variables. As we explain the functions in the library, we will understand why we defined the variables in the structures here.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>#</span> <span class=nx>define</span> <span class=nx>RxBufferSize</span> <span class=mi>260</span>
</span></span><span class=line><span class=cl><span class=nx>typedef</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>Status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>short</span> <span class=nx>Sector</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>Page</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=nx>ExtFlash_t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>typedef</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>WIP</span><span class=p>;</span> <span class=c1>//write in progress
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>WEL</span><span class=p>;</span> <span class=c1>//Write Enable Latch
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>BPbits</span><span class=p>;</span> <span class=c1>//block protect
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>QE</span><span class=p>;</span> <span class=c1>//quad enable bit
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>SRWD</span><span class=p>;</span> <span class=c1>//status register write disable bit
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=nx>StatusRegister_t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>typedef</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>SOTP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>LDSO</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>PSB</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>ESB</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>PFAIL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>EFAIL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=nx>SecurityRegister_t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>typedef</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=kt>int</span> <span class=nx>block</span><span class=p>[</span><span class=mi>16</span><span class=p>][</span><span class=mi>16</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>tx_buf</span><span class=p>[</span><span class=mi>260</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=nx>uint8_t</span> <span class=nx>page_counter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>uint8_t</span> <span class=nx>block_counter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=nx>Mem_Handle_t</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>spi_rx_buf</span><span class=p>[</span><span class=nx>RxBufferSize</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>spi_tx_buf</span><span class=p>[</span><span class=nx>RxBufferSize</span><span class=p>];</span></span></span></code></pre></td></tr></table></div></div><p>Now we need to learn the addresses of our writable memory points. For this, we go to the page below in the user guide.</p><p><figure><a class=lightgallery href=/how-to-use-flash-mem/memory-map.png title="Memory Map" data-thumbnail=/how-to-use-flash-mem/memory-map.png data-sub-html="<h2>Memory Map</h2><p>Memory Map</p>"><img class=lazyload src=/last-pr-warrior/svg/loading.min.svg data-src=/how-to-use-flash-mem/memory-map.png data-srcset="/how-to-use-flash-mem/memory-map.png, /how-to-use-flash-mem/memory-map.png 1.5x, /how-to-use-flash-mem/memory-map.png 2x" data-sizes=auto alt=/how-to-use-flash-mem/memory-map.png></a><figcaption class=image-caption>Memory Map</figcaption></figure></p><p>Every structure referred to here as &lsquo;sector&rsquo; is the page structure we just learned. There are 256 different writable addresses. In this model, 256bit data can be written to each address.</p><p>There is something I want to mention here. We said that each page structure has 256-bit space, but in the previous section, we also said that the page must be clean for every typing operation. Suppose we have piecemeal data of less than 256 bits. For example, in my project I have temperature and humidity data. There will be different small and large data in the projects that you will use. So, how should we write this data into memory with an algorithm? The answer to this question is as simple as you can imagine. First of all, we need to accumulate the data we have until it is 256 bits. Then we have to send it to a page structure we want. Otherwise, if we send each data separately to page structures, we will use our memory very inefficiently and incorrectly.</p><p>Let&rsquo;s get back to our topic. We have 256 different addresses that I can use. We will define them in our library in a different way than we know them. If we try to define each address with a different macro, this will take too long and take up too much memory. First we define the base addresses of each block structure.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>mem_offset</span>			<span class=mh>0x001000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block0_add0</span>			<span class=mh>0x000000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block1_add0</span>			<span class=mh>0x010000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block2_add0</span>			<span class=mh>0x020000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block3_add0</span>			<span class=mh>0x030000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block4_add0</span>			<span class=mh>0x040000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block5_add0</span>			<span class=mh>0x050000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block6_add0</span>			<span class=mh>0x060000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block7_add0</span>			<span class=mh>0x070000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block8_add0</span>			<span class=mh>0x080000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block9_add0</span>			<span class=mh>0x090000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block10_add0</span>		<span class=mh>0x0A0000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block11_add0</span>		<span class=mh>0x0B0000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block12_add0</span>		<span class=mh>0x0C0000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block13_add0</span>		<span class=mh>0x0D0000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block14_add0</span>		<span class=mh>0x0E0000</span>
</span></span><span class=line><span class=cl><span class=err>#</span><span class=nx>define</span> <span class=nx>block15_add0</span>		<span class=mh>0x0F0000</span></span></span></code></pre></td></tr></table></div></div><p>If we pay attention, a new usable address is obtained by adding a certain offset to the basic addresses that I have defined here. We have already defined this offset value above. Now let&rsquo;s write a function using this offset value. Let&rsquo;s create the remaining memory points with the help of this function (Ignore the remaining structures inside the function for now, I will mention them in my next explanations).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>unsigned</span> <span class=nx>char</span> <span class=nf>FlashInit</span><span class=p>(</span><span class=nx>Mem_Handle_t</span><span class=o>*</span> <span class=nx>Mem_Control</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl> 	  <span class=nx>EXTFLASHCSPIN_HIGH</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> 	 	<span class=nx>uint8_t</span> <span class=nx>k</span> <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 	<span class=k>for</span><span class=p>(</span><span class=nx>k</span><span class=p>=</span><span class=mi>0</span><span class=p>;</span><span class=nx>k</span><span class=o>&lt;=</span><span class=mi>16</span><span class=p>;</span><span class=nx>k</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl> 	 	<span class=p>{</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span>  <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block0_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span>  <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block1_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span>  <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block2_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span>  <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block3_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>4</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span>  <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block4_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>5</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span>  <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block5_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>6</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span>  <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block6_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>7</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span>  <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block7_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>8</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span>  <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block8_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>9</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span>  <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block9_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span>  <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>10</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span> <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block10_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span> <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>11</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span> <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block11_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span> <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>12</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span> <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block12_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span> <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>13</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span> <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block13_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span> <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>14</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span> <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block14_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span> <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 		<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block</span><span class=p>[</span><span class=mi>15</span><span class=p>][</span><span class=nx>k</span><span class=p>]</span> <span class=p>=</span> <span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>block15_add0</span><span class=p>)</span><span class=o>+</span><span class=p>((</span><span class=nx>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nx>mem_offset</span><span class=o>*</span><span class=nx>k</span><span class=p>)</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> 	 	<span class=p>}</span>
</span></span><span class=line><span class=cl> 	 	<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>page_counter</span> <span class=p>=</span>  <span class=mi>0</span> <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 	<span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>block_counter</span> <span class=p>=</span> <span class=mi>0</span> <span class=p>;</span>
</span></span><span class=line><span class=cl> 	 	<span class=nf>memset</span><span class=p>(</span><span class=nx>Mem_Control</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>tx_buf</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>260</span><span class=p>);</span>   <span class=c1>// clear send buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>We managed to import all our memory points into our software.</p><p>Now let&rsquo;s examine the function that sends a simple command to our peripheral. But before that, let&rsquo;s learn the commands we have by examining the command set in the user guide.</p><p><figure><a class=lightgallery href=/how-to-use-flash-mem/cmd-seet.png title="Cmd Set" data-thumbnail=/how-to-use-flash-mem/cmd-seet.png data-sub-html="<h2>Cmd Set</h2><p>Cmd Set</p>"><img class=lazyload src=/last-pr-warrior/svg/loading.min.svg data-src=/how-to-use-flash-mem/cmd-seet.png data-srcset="/how-to-use-flash-mem/cmd-seet.png, /how-to-use-flash-mem/cmd-seet.png 1.5x, /how-to-use-flash-mem/cmd-seet.png 2x" data-sizes=auto alt=/how-to-use-flash-mem/cmd-seet.png></a><figcaption class=image-caption>Cmd Set</figcaption></figure></p><p>Let&rsquo;s examine our command sending function in the library. The CS# pin is pulled low, then data is sent using SPI. Then the CS# pin is pulled to high level (logic1) and the peripheral is turned off.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>unsigned</span> <span class=nx>char</span> <span class=nf>WriteCommand</span><span class=p>(</span><span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>command</span><span class=p>,</span><span class=nx>unsigned</span> <span class=nx>short</span> <span class=nx>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>transferOK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>0</span><span class=p>]=</span><span class=nx>command</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>EXTFLASHCSPIN_LOW</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>HAL_Delay</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>//transferOK = SPI_transfer(spi_handle, &amp;spiTransaction);
</span></span></span><span class=line><span class=cl><span class=c1></span>	  <span class=nx>transferOK</span><span class=p>=</span><span class=nf>HAL_SPI_TransmitReceive</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>hspi1</span><span class=p>,</span><span class=o>&amp;</span><span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=o>&amp;</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=nx>size</span><span class=p>,</span><span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=nf>HAL_Delay</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nx>EXTFLASHCSPIN_HIGH</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>transferOK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s examine the status register reading function in the library. Here, using the command sending function above, the relevant command (see the command set) is sent to the peripheral. Then, the received data was extracted by shifting according to the bit rules found in the user guide.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>unsigned</span> <span class=nx>char</span> <span class=nf>ReadStatusRegister</span><span class=p>(</span><span class=nx>StatusRegister_t</span><span class=o>*</span> <span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>transferOK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=nx>spi_rx_buf</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>RxBufferSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>transferOK</span><span class=p>=</span><span class=nf>WriteCommand</span><span class=p>(</span><span class=mh>0x05</span><span class=p>,</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>transferOK</span><span class=o>==</span><span class=nx>HAL_OK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>BPbits</span><span class=p>=(</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=mi>2</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0xFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>QE</span><span class=p>=(</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=mi>6</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0x01</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>SRWD</span><span class=p>=(</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=mi>7</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0x01</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>WEL</span><span class=p>=(</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=mi>1</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0x01</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>WIP</span><span class=p>=</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&amp;</span><span class=mh>0x01</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>transferOK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s examine the security register reading function in the library. It has the same working logic as the above function. The only difference is that the relevant commands we send differ. You should review these commands one by one.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>unsigned</span> <span class=nx>char</span> <span class=nf>ReadSecurityRegister</span><span class=p>(</span><span class=nx>SecurityRegister_t</span><span class=o>*</span> <span class=nx>Status</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>transferOK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=nx>spi_rx_buf</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>RxBufferSize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>transferOK</span><span class=p>=</span><span class=nf>WriteCommand</span><span class=p>(</span><span class=mh>0x2B</span><span class=p>,</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>transferOK</span><span class=o>==</span><span class=nx>HAL_OK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>EFAIL</span><span class=p>=(</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=mi>6</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0x01</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>PFAIL</span><span class=p>=(</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=mi>5</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0x01</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>ESB</span><span class=p>=(</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=mi>3</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0x01</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>PSB</span><span class=p>=(</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=mi>2</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0x01</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>LDSO</span><span class=p>=(</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&gt;&gt;</span><span class=mi>1</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0x01</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Status</span><span class=o>-</span><span class=p>&gt;</span><span class=nx>SOTP</span><span class=p>=</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>&amp;</span><span class=mh>0x01</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>transferOK</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s examine the Sector Erase function in the library. This function is one of the most important functions for us. This is because we clean the relevant field using this function before writing data (I mentioned the importance of this in the first chapters). I did not understand every point of the function found here, but I understood the basic points and I will try to explain these points.</p><p>First, the WREN command in the instruction set is sent. To clear a page and send data, the WREN command must be sent before these operations. A special function is defined in the library to send this command (I will add it below). The units that store the sender and receiver data are then cleared. Then the address we are interested in (the address that will be cleaned and made suitable for writing) is loaded into the sending unit (tx buffer). Then the Sector Erase command is loaded into the sending unit (tx buffer). The uploaded address and the command are sent together to the peripheral unit with the command sending function I explained above.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>unsigned</span> <span class=nx>char</span> <span class=nf>SectorErase</span><span class=p>(</span><span class=nx>unsigned</span> <span class=kt>int</span> <span class=nx>Add</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>StatusRegister_t</span> <span class=nx>FlashStatus</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>SecurityRegister_t</span> <span class=nx>SecurityReg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>i</span><span class=p>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>transferOK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=nx>spi_rx_buf</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>RxBufferSize</span><span class=p>);</span>	 <span class=c1>// alıcı birim temizlenir 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>transferOK</span><span class=p>=</span><span class=nf>WREN</span><span class=p>();</span>			 <span class=c1>// wren komutu gönderilir 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>FlashStatus</span><span class=p>.</span><span class=nx>WEL</span><span class=p>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>while</span><span class=p>(</span><span class=nx>FlashStatus</span><span class=p>.</span><span class=nx>WEL</span><span class=o>==</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>HAL_Delay</span><span class=p>(</span><span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>transferOK</span><span class=p>=</span><span class=nf>ReadStatusRegister</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>FlashStatus</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>i</span><span class=o>==</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span><span class=p>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]=(</span><span class=nx>Add</span><span class=o>&gt;&gt;</span><span class=mi>16</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0xFF</span><span class=p>;</span>	<span class=c1>// adres , gönderme birimine (buffer) alınır
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>2</span><span class=p>]=(</span><span class=nx>Add</span><span class=o>&gt;&gt;</span><span class=mi>8</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0xFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>3</span><span class=p>]=</span><span class=nx>Add</span><span class=o>&amp;</span><span class=mh>0xFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>transferOK</span><span class=p>=</span><span class=nf>WriteCommand</span><span class=p>(</span><span class=mh>0x20</span><span class=p>,</span><span class=mi>4</span><span class=p>);</span>	<span class=c1>// sector erase komutu gönderme birimine alınarak adres ile birlikte flash&#39;a gönderilir.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>FlashStatus</span><span class=p>.</span><span class=nx>WIP</span><span class=p>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>while</span><span class=p>(</span><span class=nx>FlashStatus</span><span class=p>.</span><span class=nx>WIP</span><span class=o>==</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>HAL_Delay</span><span class=p>(</span><span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>transferOK</span><span class=p>=</span><span class=nf>ReadStatusRegister</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>FlashStatus</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nx>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nx>i</span><span class=o>==</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span><span class=p>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>transferOK</span><span class=p>=</span><span class=nf>ReadStatusRegister</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>FlashStatus</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>transferOK</span><span class=p>=</span><span class=nf>ReadSecurityRegister</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>SecurityReg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>transferOK</span><span class=o>==</span><span class=nx>HAL_OK</span> <span class=o>&amp;&amp;</span> <span class=nx>SecurityReg</span><span class=p>.</span><span class=nx>EFAIL</span><span class=o>==</span><span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>SecurityReg</span><span class=p>.</span><span class=nx>PFAIL</span><span class=o>==</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s examine the function used to send data in the library. I will describe the structure here as best as I can, only in outline.</p><p>First, the WREN command is sent and the peripheral is ready for writing. Then the send and receive units (tx rx buffer) are cleared. Then the send command is received to the sending unit (see command set). Then, the relevant address is received to the sending unit. Then the information we will send is taken to the sending unit. Then the CS# pin is pulled low. Then the whole sending unit of 260 bits is sent. Finally, the CS# pin is pulled high and the peripheral is turned off.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>unsigned</span> <span class=nx>char</span> <span class=nf>PageProgram</span><span class=p>(</span><span class=nx>unsigned</span> <span class=nx>Add</span> <span class=p>,</span> <span class=nx>unsigned</span> <span class=nx>char</span><span class=o>*</span> <span class=nx>buf</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=nx>StatusRegister_t</span> <span class=nx>FlashStatus</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>SecurityRegister_t</span> <span class=nx>SecurityReg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>uint32_t</span> <span class=nx>i</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>transferOK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>WREN</span><span class=p>();</span>		                        <span class=c1>// WREN komutu gönderildi
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>memset</span><span class=p>(</span><span class=nx>spi_rx_buf</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>RxBufferSize</span><span class=p>);</span> <span class=c1>// sıfır ile dolduruldu rx buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>memset</span><span class=p>(</span><span class=nx>spi_tx_buf</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>RxBufferSize</span><span class=p>);</span> <span class=c1>// sıfır ile dolduruldu rx buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>0</span><span class=p>]=</span> <span class=mh>0x02</span><span class=p>;</span>                <span class=c1>// yazma komutu gönderme birimine (tx buffer) alındı 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]=(</span><span class=nx>Add</span><span class=o>&gt;&gt;</span><span class=mi>16</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0xFF</span><span class=p>;</span>       <span class=c1>// adres , gönderme birimine alındı
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>2</span><span class=p>]=(</span><span class=nx>Add</span><span class=o>&gt;&gt;</span><span class=mi>8</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0xFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>3</span><span class=p>]=</span><span class=nx>Add</span><span class=o>&amp;</span><span class=mh>0xFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=nx>i</span><span class=p>=</span><span class=mi>4</span><span class=p>;</span><span class=nx>i</span><span class=p>&lt;</span><span class=mi>257</span><span class=p>;</span><span class=nx>i</span><span class=o>++</span><span class=p>)</span>              <span class=c1>// bilgi gönderme birimine alındı 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nx>spi_tx_buf</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=o>*</span><span class=nx>buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    	<span class=nx>buf</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>EXTFLASHCSPIN_LOW</span><span class=p>;</span> 																<span class=c1>// cs select
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>transferOK</span> <span class=p>=</span> <span class=nf>HAL_SPI_Transmit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>hspi1</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>260</span><span class=p>,</span> <span class=nx>HAL_MAX_DELAY</span><span class=p>);</span>		<span class=c1>//256 bitlik bütün birim gönderildi 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>EXTFLASHCSPIN_HIGH</span><span class=p>;</span> 															<span class=c1>// cs deselect
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>FlashStatus</span><span class=p>.</span><span class=nx>WIP</span><span class=p>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>while</span><span class=p>(</span><span class=nx>FlashStatus</span><span class=p>.</span><span class=nx>WIP</span><span class=o>==</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    	<span class=nf>HAL_Delay</span><span class=p>(</span><span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nx>transferOK</span><span class=p>=</span><span class=nf>ReadStatusRegister</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>FlashStatus</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    	<span class=nx>i</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    	<span class=k>if</span><span class=p>(</span><span class=nx>i</span><span class=o>==</span><span class=mi>200</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    	<span class=p>{</span>
</span></span><span class=line><span class=cl>    		<span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span><span class=p>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>transferOK</span><span class=p>=</span><span class=nf>ReadStatusRegister</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>FlashStatus</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>transferOK</span><span class=p>=</span><span class=nf>ReadSecurityRegister</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>SecurityReg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>transferOK</span><span class=o>==</span><span class=nx>HAL_OK</span> <span class=o>&amp;&amp;</span> <span class=nx>SecurityReg</span><span class=p>.</span><span class=nx>EFAIL</span><span class=o>==</span><span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>SecurityReg</span><span class=p>.</span><span class=nx>PFAIL</span><span class=o>==</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    	<span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s examine the function written to read a page in the library. First, the receiving unit (tx buffer) is cleared. Then the read command and the corresponding address are received to the sending unit. Then the peripheral is activated by pulling the CS# pin to low level. Then the sending unit (tx buffer) is sent. Then, the data is expected and received with the &lsquo;receive&rsquo; command for the next data. Finally, the CS# pin is pulled high and the peripheral is turned off.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>unsigned</span> <span class=nx>char</span> <span class=nf>CheckPage</span><span class=p>(</span><span class=nx>unsigned</span> <span class=nx>Add</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=nx>unsigned</span> <span class=nx>char</span> <span class=nx>transferOK</span> <span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>memset</span><span class=p>(</span><span class=nx>spi_rx_buf</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=nx>RxBufferSize</span><span class=p>);</span> <span class=c1>//rx buferı 0 ile dolduruldu
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>0</span><span class=p>]=</span><span class=mh>0x03</span><span class=p>;</span>		  <span class=c1>// okuma komutu , gönderme birimine alınır 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>1</span><span class=p>]=(</span><span class=nx>Add</span><span class=o>&gt;&gt;</span><span class=mi>16</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0xFF</span><span class=p>;</span>	  <span class=c1>// ilgili adres , gönderme birimine alınır 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>2</span><span class=p>]=(</span><span class=nx>Add</span><span class=o>&gt;&gt;</span><span class=mi>8</span><span class=p>)</span><span class=o>&amp;</span><span class=mh>0xFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>3</span><span class=p>]=</span><span class=nx>Add</span><span class=o>&amp;</span><span class=mh>0xFF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>EXTFLASHCSPIN_LOW</span><span class=p>;</span> 									<span class=c1>// cs select
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>transferOK</span> <span class=p>=</span> <span class=nf>HAL_SPI_Transmit</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>hspi1</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>spi_tx_buf</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>500</span><span class=p>);</span>	<span class=c1>//komut ve adres gönderilir 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>transferOK</span> <span class=p>=</span> <span class=nf>HAL_SPI_Receive</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>hspi1</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>spi_rx_buf</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=mi>260</span><span class=p>,</span> <span class=mi>500</span><span class=p>);</span>	<span class=c1>//veri okunur
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>EXTFLASHCSPIN_HIGH</span><span class=p>;</span> <span class=c1>// cs deselect
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>transferOK</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Resources I used while writing my article:</p><ul><li><p>Manufacturer user guideline</p></li><li><p><a href=https://flashdba.com/2014/06/20/understanding-flash-blocks-pages-and-program-erases/ target=_blank rel="noopener noreffer">https://flashdba.com/2014/06/20/understanding-flash-blocks-pages-and-program-erases/</a></p></li><li><p><a href=http://donanimara.blogcu.com/flash-memory-flash-bellek-nedir-cesitleri/3007570 target=_blank rel="noopener noreffer">http://donanimara.blogcu.com/flash-memory-flash-bellek-nedir-cesitleri/3007570</a></p></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-09-20&nbsp;<a class=git-hash href=https://github.com/dillonzq/LoveIt/commit/6f9c8deab6601a0032dede88ca716b4cb4353baf target=_blank title="commit by AlperenErdogan99(falperenerdogan998@gmail.com) 6f9c8deab6601a0032dede88ca716b4cb4353baf: integrate with new theme all of thing">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>6f9c8de</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/last-pr-warrior/how-to-use-external-flash-memorymx25r8035f-with-stm32/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://alperenerdogan99.github.io/last-pr-warrior/how-to-use-external-flash-memorymx25r8035f-with-stm32/ data-title="How to Use External Flash Memory(MX25R8035F) with Stm32"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://alperenerdogan99.github.io/last-pr-warrior/how-to-use-external-flash-memorymx25r8035f-with-stm32/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://alperenerdogan99.github.io/last-pr-warrior/how-to-use-external-flash-memorymx25r8035f-with-stm32/ data-title="How to Use External Flash Memory(MX25R8035F) with Stm32"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://alperenerdogan99.github.io/last-pr-warrior/how-to-use-external-flash-memorymx25r8035f-with-stm32/ data-title="How to Use External Flash Memory(MX25R8035F) with Stm32"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://alperenerdogan99.github.io/last-pr-warrior/how-to-use-external-flash-memorymx25r8035f-with-stm32/ data-title="How to Use External Flash Memory(MX25R8035F) with Stm32"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/last-pr-warrior/>Home</a></span></section></div><div class=post-nav><a href=/last-pr-warrior/how-to-use-wiznet5500/ class=next rel=next title="How to use Wiznet5500 with Stm32">How to use Wiznet5500 with Stm32<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.103.1">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/last-pr-warrior/ target=_blank>Alperen Erdogan</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/last-pr-warrior/lib/valine/valine.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/valine@1.5.0/dist/Valine.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{valine:{appId:"QGzwQXOqs5JOhN4RGPOkR2mR-MdYXbMMI",appKey:"WBmoGyJtbqUswvfLh6L8iEBr",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"en",pageSize:10,placeholder:"Your comment ...",recordIP:!0,serverURLs:"https://leancloud.hugoloveit.com",visitor:!0}},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.en",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/last-pr-warrior/js/theme.min.js></script></body></html>